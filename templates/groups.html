{% extends "base.html" %}

{% block doctitle %}Groups{% endblock %}
{% block title %}Groups{% endblock %}

{% block head %}
<style>
.group { padding-left: 2em; }
body {
	font-family: Tahoma, Arial, sans;
	font-size: 1em;
}
.new, .del { font-size: 0.8em; }
.expand {
	font-family: Courier, monospace;
	font-weight: bold;
	cursor: pointer;
	margin: 0.5em;
}
.children { }
</style>
<script src="/static/jquery.js" type="text/javascript"></script>
<script src="/static/jqueryUI.js" type="text/javascript"></script>
<script src="/static/jquery.blockUI.js" type="text/javascript"></script>
<script src="/static/script.js" type="text/javascript"></script>
<script language="JavaScript">



var groups = {{ groups_json|safe }};
var newGroup = null;

function displayLinks(g, d) {
	var node = $(g.div).children('span');
	$(node).children('.new').css('display', d);
	$(node).children('.del').css('display', d);
}

function showLinks(g) {
	displayLinks(g, 'inline');
}

function hideLinks(g) {
	displayLinks(g, 'none');
}

function expandCollapse(g) {
	if (!g.children || g.children.length == 0)
	return;
	var node = $(g.div).children('span');
	var children = $(g.div).children('.children');
	if (children.css('display') == 'block') {
		children.css('display', 'none');
		$(node).children('.expand').html('+');
	} else {
		children.css('display', 'block');
		$(node).children('.expand').html('-');
	}
}

function createGroupDiv(g) {
	var div = $('<div class="group"><span>' + 
		'<span class="expand">&nbsp;</span>' + g.name + '&nbsp;' + 
		'<a href="#" class="new">new</a>&nbsp;' + 
		'<a href="#" class="del">delete</a></span>' + 
		'<div class="children"></div>');
	g.div = div;
	div.data = g;
	var node = $(div).children('span');
	$(node).mouseover(function() { showLinks(g); });
	$(node).mouseout (function() { hideLinks(g); });
	hideLinks(g);
	$(node).children('.expand').click(function() { expandCollapse(g); });
	$(node).children('.new').click(function() { return startNewGroup(g); });
	$(node).children('.del').click(function() { return deleteGroup(g); });
	return div;
}

function createGroup(pg, g, div) {
	div.remove();
	var name = $(div).children("input")[0].value;
	var g = { name: name, parent: pg.id, id: null, children: [] };
	div = createGroupDiv(g);
	g.div = div;
	pg.children.push(g);
	g.parentGroup = pg;
	div.appendTo(pg.div.find('.children')[0]);

	$(pg.div).children('span').children('.expand').html(
		($(pg.div).children('.children').css('display') == 'none') ? '+' : '-');

	block('#tree', 0, 300);
	$.ajax({
		url: '/groups_post/',
		type: 'GET', 
		cache: false,
		dataType: 'json',
		data: { name: g.name, id: pg.id },
		async: true,
		success: function(data) {
			//alert(data ? data.id : data);
			g.id = data.id;
		},
		error: function () { 
			alert("error");
		},
		complete: reduce2(unblockElement, "#tree", 0)
	});
	return false;
}

function cancelNewGroup(g, ng, div) {
	div.remove();
	newGroup = null;
	return false;
}

function createNewGroupDiv(g, ng) {
	var div = $('<div class="group"><input type="text" value="' + 
		ng.name + '"/>&nbsp;' + 
		'<a href="#">ok</a>&nbsp;<a href="#">cancel</a></div>');
	$(div.find('a')[0]).click(function() { return createGroup(g, ng, div); });
	$(div.find('a')[1]).click(function() { return cancelNewGroup(g, ng, div); });
	div.data = ng;
	return div;
}

function startNewGroup(g) {
	if (newGroup != null)
		newGroup.div.remove();
	newGroup = { name: 'new group', parent: g.id, id: null };
	var div = createNewGroupDiv(g, newGroup);
	newGroup.div = div;
	div.appendTo(g.div.find('.children')[0]);
	$(g.div).children('.children').css('display', 'block');
	//div.children('input')[0].focus();
	return false;
}

function indexOf(a, o) {
	for (var i = 0; i < a.length; i++)
		if (a[i] == o)
			return i;
	return -1;
}

function deleteGroup(g) {
	g.div.remove();
	if (g.parentGroup) {
		g.parentGroup.children.splice(
			indexOf(g.parentGroup.children, g), 1);

		if (g.parentGroup.children.length <= 0)
		$(g.parentGroup.div).children('span').
			children('.expand').html('&nbsp;');
	}

	block('#tree', 0, 300);
	$.ajax({
		url: '/groups_delete/',
		type: 'GET', 
		cache: false,
		dataType: 'json',
		data: { id: g.id },
		async: true,
		success: function(data) {
			//alert(data ? data.id : data);
			//g.id = data.id;
		},
		error: function () { 
			alert("error");
		},
		complete: reduce2(unblockElement, "#tree", 0)
	});
	return false;
}

function createTree2(id, g) {
	var div = createGroupDiv(g);
	g.div = div;
	if (g.children) {
		for (var i = 0; i < g.children.length; i++) {
			createTree2(id, g.children[i]).appendTo(
					$(div).children('.children'));
		}
	}
	return div;
}

function createTree(id) {
	var tree = [];
	var t = [];
	for (var i = 0; i < groups.length; i++) {
		var g = groups[i];
		t[g.id] = g;
		g.children = [];
	}
	for (var i = 0; i < groups.length; i++) {
		var g = groups[i];
		if (g.parent == null) {
			tree.push(g);
		} else {
			var pg = t[g.parent];
			if (!pg)
				continue;
			if (!pg.children)
				pg.children = [];
			pg.children.push(g);
			g.parentGroup = pg;
		}
	}
	for (var i = 0; i < tree.length; i++) {
		createTree2(id, tree[i]).appendTo($(id)[0]);
	}
}

$(document).ready(function() {
	createTree('#tree');
});
</script>
{% endblock %}

{% block content %}
<div id="tree">end tree</div>
<div>
{% for g in groups %}
<div class="group">{{g}}<a href="#">New</a><a href="#">Delete</a>{{g.key}}</div>
{% endfor %}

<form action="/groups/" method="post">
<input type="text" name="groupName"/><input type="submit" value="New"/>
</form>
</div>
{% endblock %}
